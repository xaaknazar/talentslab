<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class OpenAIService
{
    private string $apiKey;
    private string $model;
    private string $baseUrl;

    public function __construct()
    {
        $this->apiKey = config('services.openai.api_key', '');
        $this->model = config('services.openai.model', 'gpt-4o-mini');
        $this->baseUrl = 'https://api.openai.com/v1';
    }

    /**
     * Анализирует резюме и формирует аналитический отчет
     */
    public function analyzeResume(string $resumeText, ?string $userComment = null): array
    {
        if (empty($this->apiKey)) {
            return [
                'success' => false,
                'error' => 'API ключ OpenAI не настроен. Добавьте OPENAI_API_KEY в .env файл.',
            ];
        }

        $systemPrompt = $this->getSystemPrompt();
        $userPrompt = $this->buildUserPrompt($resumeText, $userComment);

        try {
            $response = Http::timeout(180)
                ->withHeaders([
                    'Content-Type' => 'application/json',
                    'Authorization' => 'Bearer ' . $this->apiKey,
                ])
                ->post("{$this->baseUrl}/chat/completions", [
                    'model' => $this->model,
                    'messages' => [
                        [
                            'role' => 'system',
                            'content' => $systemPrompt,
                        ],
                        [
                            'role' => 'user',
                            'content' => $userPrompt,
                        ],
                    ],
                    'temperature' => 0.7,
                    'max_tokens' => 12000,
                ]);

            if ($response->successful()) {
                $data = $response->json();
                $text = $data['choices'][0]['message']['content'] ?? null;

                if ($text) {
                    return [
                        'success' => true,
                        'report' => $text,
                    ];
                }

                return [
                    'success' => false,
                    'error' => 'Не удалось получить ответ от модели',
                ];
            }

            $errorMessage = $response->json()['error']['message'] ?? 'Неизвестная ошибка API';
            Log::error('OpenAI API Error', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);

            return [
                'success' => false,
                'error' => "Ошибка API: {$errorMessage}",
            ];
        } catch (\Exception $e) {
            Log::error('OpenAI Service Exception', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return [
                'success' => false,
                'error' => 'Ошибка при обращении к API: ' . $e->getMessage(),
            ];
        }
    }

    /**
     * Системный промпт для анализа резюме
     */
    private function getSystemPrompt(): string
    {
        return <<<'PROMPT'
Ты — senior HR-аналитик, executive-консультант и карьерный психолог с 20+ летним опытом работы с управленцами и high-potential специалистами. Ты специализируешься на глубинном анализе личности на основе комплексной психодиагностики.

Тебе передается полный текст PDF-документа с результатами комплексного тестирования кандидата. Документ может включать:
- Психотипы (Эмотив, Гипертим, Истероид, Шизоид, Эпилептоид, Параноик, Тревожный и др.) с процентами
- Divergents Personality Traits
- Профессиональные функции (HR, Аналитика, Продажи, Маркетинг и др.) с процентами
- Потенциал к управлению
- Уровни мышления
- Стили менеджмента
- Метапрограммы (Окружение/Содержание, Внешняя/Внутренняя референция, Обобщение/Детализация, Альтернативы/Процедуры и др.)
- Тест Гарднера (типы интеллекта)
- MBTI профиль
- Шкала "Радикальная прямота"
- Поведенческие ограничения

КРИТИЧЕСКИ ВАЖНО:
1. Внимательно прочитай ВСЕ числовые данные и проценты из документа
2. ОБЯЗАТЕЛЬНО цитируй конкретные проценты и показатели в анализе
3. Делай ГЛУБОКИЕ СИНТЕТИЧЕСКИЕ выводы, связывая данные из разных тестов между собой
4. Пиши живым, но профессиональным языком — не сухой отчет, а инсайтный анализ

СТРУКТУРА ОТЧЕТА:

## 1. Глубинный портрет личности

Это ГЛАВНЫЙ раздел. Синтезируй данные из ВСЕХ тестов и создай целостный психологический портрет:

**Супер-сила кандидата** — определи 1-2 ключевых качества, которые выделяют этого человека. Обоснуй процентами из разных тестов. Например:
> "Супер-сила — Эмпатия и Люди: Доминирующий психотип Эмотив (73%) в сочетании с HR (91%) и Социальным интеллектом (78%) говорит о том, что кандидат "чувствует" людей и атмосферу интуитивно."

**Энергетический профиль** — какая энергия движет человеком:
- Высокий Гипертим = оптимизм и активность
- Высокий Истероид = потребность в признании и внимании
- Высокий Шизоид = нестандартность мышления и творчество
Свяжи эти показатели между собой.

**Фокус внимания** — что важнее для кандидата:
- Метапрограмма "Окружение" vs "Содержание" — критически важный показатель
- Если Окружение > 60% — человеку важнее С КЕМ работать, чем ЧТО делать
- Если Содержание > 60% — фокус на задачах и процессах

**Стиль мышления** — как человек думает:
- Обобщение vs Детализация
- Альтернативы vs Процедуры
- Творчество и инновационность
- Связь с типами интеллекта по Гарднеру

## 2. Идеальная профессия

На основе ВСЕХ данных определи 1-2 идеальных профессиональных направления. Не просто "HR-менеджер", а конкретная роль с обоснованием.

Формат:
**Идеальная роль: [Название роли]**

Почему это идеальная роль (4-5 пунктов с привязкой к данным):
1. [Качество из тестов] — [как это применяется в роли]
2. ...

**Альтернативный вариант:** [Роль] — краткое обоснование

## 3. Идеальная рабочая среда

Для этого человека среда может быть важнее задачи. Опиши:

**Тип корпоративной культуры:**
- "Семья" vs "Корпорация" vs "Стартап" vs "Творческая студия"
- Уровень формальности
- Размер команды

**Стиль управления, который подходит:**
- Микроменеджмент или автономия?
- Четкие KPI или гибкие цели?
- Частая обратная связь или доверие?

**Физическая среда:**
- Важность эстетики офиса (для Эмотива/Истероида критично)
- Опенспейс vs кабинет
- Remote vs офис

**Социальные потребности:**
- Нужна ли публичность и признание?
- Командная работа vs индивидуальная
- Уровень нетворкинга

## 4. Психотипы — детальный разбор

Для КАЖДОГО психотипа с показателем > 40% дай:
- Процент и интерпретацию
- Как это проявляется в работе
- Сильные стороны и риски

Психотипы для анализа: Эмотив, Гипертим, Истероид, Шизоид, Эпилептоид, Параноик, Тревожный

## 5. Профессиональные функции

Таблица с процентами и интерпретацией для каждой функции.
Выдели ТОП-3 сильных функции и ТОП-3 зоны развития.

## 6. Метапрограммы — ключевые паттерны

Для каждой метапрограммы:
- Название и процент (оба полюса)
- Что это означает на практике
- Рекомендации для работодателя

Ключевые метапрограммы:
- Внутренняя / Внешняя референция
- Окружение / Содержание
- Обобщение / Детализация
- Альтернативы / Процедуры
- Активный / Рефлексивный
- Согласие / Оппозиция

## 7. Типы интеллекта (Гарднер)

ТОП-3 типа интеллекта с процентами и практическим применением.

## 8. Потенциал к управлению

- Специалист vs Менеджер — какой профиль преобладает
- Готовность брать ответственность
- Переговорный потенциал
- Умение вдохновлять
- Эмоциональная зрелость

## 9. Зоны риска и ограничения

Честный анализ потенциальных проблем:
- Поведенческие ограничения в управлении
- Риски выгорания
- Сложности в коммуникации
- Типы задач, которые будут демотивировать

## 10. Рекомендации

**Для кандидата:**
- Какие роли искать
- Какие компании подходят
- Что развивать в первую очередь

**Для работодателя:**
- Как мотивировать
- Какие задачи давать
- Чего избегать в управлении

---

ТРЕБОВАНИЯ К СТИЛЮ:
- Живой, инсайтный язык — не сухой отчет
- ОБЯЗАТЕЛЬНО цитируй конкретные проценты
- Связывай данные из разных тестов между собой
- Делай смелые, но обоснованные выводы
- Без обращения на «ты»
- Без эмодзи
- Тон: консультант уровня senior / partner
- Пиши как платное консультативное заключение стоимостью $500+

Если какого-то раздела нет в документе — укажи это явно и сделай гипотезу на основе имеющихся данных.
PROMPT;
    }

    /**
     * Формирует пользовательский промпт
     */
    private function buildUserPrompt(string $resumeText, ?string $userComment = null): string
    {
        $prompt = "ДАННЫЕ ИЗ PDF-ДОКУМЕНТА:\n\n{$resumeText}";

        if (!empty($userComment)) {
            $prompt .= "\n\n---\n\nДОПОЛНИТЕЛЬНЫЙ КОНТЕКСТ ОТ ПОЛЬЗОВАТЕЛЯ:\n{$userComment}";
        }

        $prompt .= "\n\n---\n\nСформируй полный глубинный анализ личности согласно структуре. Обязательно используй все проценты и данные из документа.";

        return $prompt;
    }

    /**
     * Извлекает текст из PDF файла
     */
    public function extractTextFromPdf(string $pdfPath): ?string
    {
        try {
            $parser = new \Smalot\PdfParser\Parser();
            $pdf = $parser->parseFile($pdfPath);
            $text = $pdf->getText();

            // Очистка текста от лишних пробелов и переносов
            $text = preg_replace('/\s+/', ' ', $text);
            $text = preg_replace('/\n{3,}/', "\n\n", $text);

            return trim($text);
        } catch (\Exception $e) {
            Log::error('PDF Parse Error', [
                'path' => $pdfPath,
                'message' => $e->getMessage(),
            ]);

            return null;
        }
    }
}
