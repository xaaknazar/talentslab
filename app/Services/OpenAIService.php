<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class OpenAIService
{
    private string $apiKey;
    private string $model;
    private string $baseUrl;

    public function __construct()
    {
        $this->apiKey = config('services.openai.api_key', '');
        $this->model = config('services.openai.model', 'gpt-4o-mini');
        $this->baseUrl = 'https://api.openai.com/v1';
    }

    /**
     * Анализирует резюме и формирует аналитический отчёт
     */
    public function analyzeResume(string $resumeText, ?string $userComment = null): array
    {
        if (empty($this->apiKey)) {
            return [
                'success' => false,
                'error' => 'API ключ OpenAI не настроен. Добавьте OPENAI_API_KEY в .env файл.',
            ];
        }

        $systemPrompt = $this->getSystemPrompt();
        $userPrompt = $this->buildUserPrompt($resumeText, $userComment);

        try {
            $response = Http::timeout(120)
                ->withHeaders([
                    'Content-Type' => 'application/json',
                    'Authorization' => 'Bearer ' . $this->apiKey,
                ])
                ->post("{$this->baseUrl}/chat/completions", [
                    'model' => $this->model,
                    'messages' => [
                        [
                            'role' => 'system',
                            'content' => $systemPrompt,
                        ],
                        [
                            'role' => 'user',
                            'content' => $userPrompt,
                        ],
                    ],
                    'temperature' => 0.7,
                    'max_tokens' => 8192,
                ]);

            if ($response->successful()) {
                $data = $response->json();
                $text = $data['choices'][0]['message']['content'] ?? null;

                if ($text) {
                    return [
                        'success' => true,
                        'report' => $text,
                    ];
                }

                return [
                    'success' => false,
                    'error' => 'Не удалось получить ответ от модели',
                ];
            }

            $errorMessage = $response->json()['error']['message'] ?? 'Неизвестная ошибка API';
            Log::error('OpenAI API Error', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);

            return [
                'success' => false,
                'error' => "Ошибка API: {$errorMessage}",
            ];
        } catch (\Exception $e) {
            Log::error('OpenAI Service Exception', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return [
                'success' => false,
                'error' => 'Ошибка при обращении к API: ' . $e->getMessage(),
            ];
        }
    }

    /**
     * Системный промпт для анализа резюме
     */
    private function getSystemPrompt(): string
    {
        return <<<'PROMPT'
Ты — senior HR-аналитик, executive-консультант и карьерный стратег с опытом работы с управленцами и high-potential специалистами.

Тебе передается полный текст PDF-документа, который содержит комплексную оценку кандидата. Этот документ включает:
- Резюме и опыт работы
- Результаты тестирования с ПРОЦЕНТАМИ и ЧИСЛОВЫМИ показателями
- Психотипы
- Профессиональные функции (с процентами)
- Потенциал к управлению (с процентами)
- Уровни мышления (с процентами)
- Стили менеджмента (с процентами)
- Поведенческие ограничения, препятствующие делегированию
- Шкала "Радикальная прямота"
- Тест Гарднера (типы интеллекта с процентами)
- MBTI профиль
- Метапрограммы

КРИТИЧЕСКИ ВАЖНО:
1. Внимательно прочитай ВСЕ числовые данные и проценты из документа
2. В своем анализе ОБЯЗАТЕЛЬНО ссылайся на конкретные проценты и цифры из отчета
3. Делай выводы, ОПИРАЯСЬ на эти данные. Например: "Согласно результатам теста, показатель стратегического мышления составляет 78%, что указывает на..."
4. Сравнивай показатели между собой для более глубокого анализа

СТРУКТУРА ОТЧЕТА (строго соблюдай):

## 1. Общий профессиональный профиль
- Кто этот человек как специалист (с учетом данных тестирования)
- Основной вектор карьеры
- Тип роли (исполнитель / эксперт / управленец) — обоснуй процентами из отчета
- Логика переходов между позициями
- Степень осознанности карьерного пути

## 2. Профессиональные функции
Анализируй данные из PDF с указанием конкретных процентов:
- Аналитика — укажи процент и интерпретируй
- Продажи — укажи процент и интерпретируй
- Клиентоориентированность — укажи процент и интерпретируй
- Исследования — укажи процент и интерпретируй
- Маркетинг — укажи процент и интерпретируй
- HR — укажи процент и интерпретируй
- Операционный менеджмент — укажи процент и интерпретируй
- Проектный менеджмент — укажи процент и интерпретируй
- Стратегия — укажи процент и интерпретируй
- Коучинг — укажи процент и интерпретируй
- Технологии — укажи процент и интерпретируй

Выдели ТОП-3 сильных функции и ТОП-3 зоны развития на основе процентов.

## 3. Потенциал к управлению
Используй данные из раздела "Потенциал к управлению" с процентами:
- Специалист vs Менеджер — какой профиль преобладает и почему (с цифрами)
- Потенциал роста (процент и интерпретация)
- Готовность брать ответственность
- Переговорный потенциал
- Умение вдохновлять
- Эмоциональная зрелость

## 4. Уровни мышления
Анализируй с указанием процентов из документа:
- Операционное мышление — X%
- Тактическое мышление — X%
- Стратегическое мышление — X%
- Критическое мышление — X%
- Инновационное мышление — X%

Сделай вывод о доминирующем типе мышления и что это означает для карьеры.

## 5. Стили менеджмента
На основе данных из PDF укажи проценты и определи:
- Основной стиль (самый высокий процент)
- Вспомогательные стили
- Рекомендации по развитию стилей

Стили: Демократический, Обучающий, Авторитарный, Товарищеский, Амбициозный

## 6. Поведенческие ограничения в управлении
Анализируй раздел "Поведенческие ограничения, препятствующие делегированию":
- Склонность к микроменеджменту
- Гиперответственность
- Страх делегирования
- Перфекционизм
- Избегание конфликтов

Укажи конкретные показатели и риски.

## 7. Шкала «Радикальная прямота»
Проанализируй данные из соответствующего раздела:
- Эмпатия — X% (интерпретация)
- Прямота — X% (интерпретация)
- Баланс и потенциальные перекосы
- Управленческие риски

## 8. Тест Гарднера — Типы интеллекта
Укажи все типы интеллекта с процентами из теста:
- Лингвистический — X%
- Логико-математический — X%
- Пространственный — X%
- Музыкальный — X%
- Телесно-кинестетический — X%
- Внутриличностный — X%
- Межличностный — X%
- Натуралистический — X%
- Экзистенциальный — X%

Выдели ТОП-3 доминирующих типа и что это значит для профессиональной деятельности.

## 9. MBTI и Метапрограммы
- Укажи тип MBTI если есть в документе
- Проанализируй метапрограммы с их значениями
- Сделай выводы о поведенческих паттернах

## 10. Итоговые выводы
- **Ключевые сильные стороны** (ТОП-5 на основе всех данных)
- **Зоны роста** (ТОП-3 с конкретными рекомендациями)
- **Оптимальные роли** — какие позиции подходят лучше всего
- **Рекомендации на 6–12 месяцев** — конкретный план развития

ТРЕБОВАНИЯ К СТИЛЮ:
- Деловой аналитический язык
- ОБЯЗАТЕЛЬНО указывай конкретные проценты и цифры из документа
- Каждый вывод должен быть подкреплен данными
- Без воды и общих фраз
- Без обращения на «ты»
- Без эмодзи
- Четкие формулировки
- Тон: консультант уровня senior / partner
- Пиши как платное консультативное заключение для руководителя, HR или самого кандидата

Если какого-то раздела нет в документе — укажи это и сделай гипотезу на основе имеющихся данных.
PROMPT;
    }

    /**
     * Формирует пользовательский промпт
     */
    private function buildUserPrompt(string $resumeText, ?string $userComment = null): string
    {
        $prompt = "ТЕКСТ РЕЗЮМЕ:\n\n{$resumeText}";

        if (!empty($userComment)) {
            $prompt .= "\n\n---\n\nДОПОЛНИТЕЛЬНЫЙ ЗАПРОС/КОММЕНТАРИЙ ОТ ПОЛЬЗОВАТЕЛЯ:\n{$userComment}";
        }

        $prompt .= "\n\n---\n\nСформируй полный аналитический отчёт согласно структуре.";

        return $prompt;
    }

    /**
     * Извлекает текст из PDF файла
     */
    public function extractTextFromPdf(string $pdfPath): ?string
    {
        try {
            $parser = new \Smalot\PdfParser\Parser();
            $pdf = $parser->parseFile($pdfPath);
            $text = $pdf->getText();

            // Очистка текста от лишних пробелов и переносов
            $text = preg_replace('/\s+/', ' ', $text);
            $text = preg_replace('/\n{3,}/', "\n\n", $text);

            return trim($text);
        } catch (\Exception $e) {
            Log::error('PDF Parse Error', [
                'path' => $pdfPath,
                'message' => $e->getMessage(),
            ]);

            return null;
        }
    }
}
